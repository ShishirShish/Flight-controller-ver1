#include "dshot.h"

#define FRAME_LEN 16
static uint16_t dma_buf[MOTOR_COUNT][FRAME_LEN];
static uint16_t t0, t1;

extern TIM_HandleTypeDef htim2;
extern TIM_HandleTypeDef htim3;

static uint16_t make_packet(uint16_t v)
{
    v <<= 1;
    uint16_t csum = 0;
    for (int i = 0; i < 3; i++) {
        csum ^= v;
        v >>= 4;
    }
    return (v << 4) | (csum & 0xF);
}

void dshot_init(uint16_t mode)
{
    uint16_t period = (mode == DSHOT1200) ? 70 : 140;
    t1 = (period * 3) / 4;
    t0 = (period * 3) / 8;
}

void dshot_send(uint8_t motor, uint16_t throttle)
{
    uint16_t pkt = make_packet(throttle);

    for (int i = 0; i < FRAME_LEN; i++)
        dma_buf[motor][i] = (pkt & (1 << (15 - i))) ? t1 : t0;

    HAL_TIM_PWM_Start_DMA(&htim2, TIM_CHANNEL_1, (uint32_t*)dma_buf[motor], FRAME_LEN);
}

