#include "imu.h"

extern I2C_HandleTypeDef hi2c1;

imu_raw_t imu_raw;
imu_scaled_t imu;

static uint8_t imu_buf[14];

void imu_init(void)
{
    /* Sensor already powered; assume default config */
}

void imu_read_dma(void)
{
    HAL_I2C_Mem_Read_DMA(
        &hi2c1,
        ICM42670_ADDR << 1,
        0x1F, /* ACCEL_XOUT_H */
        I2C_MEMADD_SIZE_8BIT,
        imu_buf,
        14
    );
}

void HAL_I2C_MemRxCpltCallback(I2C_HandleTypeDef *hi2c)
{
    if (hi2c == &hi2c1) {
        imu_raw.ax = (imu_buf[0] << 8) | imu_buf[1];
        imu_raw.ay = (imu_buf[2] << 8) | imu_buf[3];
        imu_raw.az = (imu_buf[4] << 8) | imu_buf[5];
        imu_raw.gx = (imu_buf[8] << 8) | imu_buf[9];
        imu_raw.gy = (imu_buf[10] << 8) | imu_buf[11];
        imu_raw.gz = (imu_buf[12] << 8) | imu_buf[13];

        imu.ax = imu_raw.ax * 0.000488f;
        imu.ay = imu_raw.ay * 0.000488f;
        imu.az = imu_raw.az * 0.000488f;
        imu.gx = imu_raw.gx * 0.061f;
        imu.gy = imu_raw.gy * 0.061f;
        imu.gz = imu_raw.gz * 0.061f;
    }
}
